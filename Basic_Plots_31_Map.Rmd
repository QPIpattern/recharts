---
title: "Basic Plots 31 - Map"
output: 
  html_document: 
    number_sections: yes
    toc: yes
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

First, you should load `recharts`:
```{r}
library(recharts)
```

# Introduction

Map includes 4 basic types:

- China Map
- China Map with Multiple Selection
- World Map
- World Map with Multiple Selection

<table id='intro'>
<tr><td>
```{r,echo=FALSE}
echartr(ChinaGDP[ChinaGDP$Year==2014,], Prov, GDP, type="map_china") %>%
    setDataRange(splitNumber=0, 
                 color=c('red','orange','yellow','limegreen','green')) %>%
    setTitle("China GDP by Provice, 2014") %>%
    setTheme('infographic', width=400, height=300)
```
</td>
<td>
```{r,echo=FALSE}
echartr(ChinaGDP[ChinaGDP$Year==2014,], Prov, GDP, type="map_china_multi") %>%
    setDataRange(splitNumber=0, min=0,
                 color=c('red','orange','yellow','limegreen','green')) %>%
    setTitle("China GDP by Provice, 2014") %>%
    setTheme('roma', width=400, height=300)
```
</td></tr>
<tr><td>
```{r, echo=FALSE}
worldgdp <- data.frame(
    country=c('United States of America','China','Japan','Germany',
              'United Kingdom','France','Brazil', 'Italy','India','Russia',
              'Canada','Australia','South Korea','Spain','Mexico','Indonesia',
              'Netherlands','Turkey','Saudi Arabia','Switzerland'),
    GDP=c(17418925,10380380,4616335,3859547,2945146,2846889,2353025,2147952,
          2049501,1857461,1788717,1444189,1416949,1406855,1282725,888648,866354,
          806108,752459,712050))
echartr(worldgdp, country, GDP, type="map_world") %>%
    setDataRange(splitNumber=0, 
                 color=getColFromPal('rainbow')) %>%
    setTitle("World GDP Top 20, 2014") %>%
    setTheme('macarons', width=400, height=300)
```
</td>
<td>
```{r,echo=FALSE}
echartr(worldgdp, country, GDP, type="map_world_multi") %>%
    setDataRange(splitNumber=0, 
                 color=getColFromPal('rainbow')) %>%
    setTitle("World GDP Top 20, 2014") %>%
    setTheme('macarons2', width=400, height=300)
```
</td></tr>
</table>

The keys are:

- Base Map Mode:
    - Simply assign `type` and/or `subtype` to display the base map
- Data Map Mode:
  - character `x`
    - `x[,1]` must be valid geographic names, e.g., 'United States of America' instead of 'USA' or 'U.S.'.
    - if `x[,2]` is given, it is data series variable.
  - numeric/logical `y`
    - `y[,1]`: value
    - `y[,2]`: logical, if is selected. Also allowed to use 1 for TRUE, 0 for FALSE.
  - series is mapped to separate maps, i.e., each level of series represents a map. The series variable should also be valid geograhic names.
- You can additionally add map data to the echarts object
    - `addNameMap` for geoName mapping/translation; 
    - `addHeatMap` for additional heatmap graph layer
    - `addMarkLine` or `addMarkPoint` to add markLines and/or markPoints
        - `addGeoCoord` to define coordinates of the places for markLine and markPoint

# Function Call

```r
echartr(data, <x>, <y>, <series>, <lng>, <lat>, <z>, <type>, <subtype>)
```

+--------+--------------------------------------------------------------------+
| Arg    |  Requirement                                                       |
+========+====================================================================+
|**data**| source data in the form of data.frame |
+--------+--------------------------------------------------------------------+
| **x**  | character independent variable. Other type will be coerced to factors. Only the first 2 are accepted if multiple variables are provided. `x[,1]` must be valid geographic names. if `x[,2]` is given, it is used as data series variable. |
+--------+--------------------------------------------------------------------+
| **y**  | numeric dependent variable. Only the first 2 are accepted if multiple variables are provided. `y[,1]` acts as the value and `y[,2]` (logical) represents the status of selected/unselected. It is also allowed to use 1 for TRUE, 0 for FALSE in `y[,2]`. |
+--------+--------------------------------------------------------------------+
| series | series variable which will be coerced to factors. Each level of `series` is treated as a subsetting factor to produce separate maps. Only the first one is accepted if multiple variables are provided. |
+--------+--------------------------------------------------------------------+
|  z     | timeline variable which will be coerced to factors. Only the first one is accepted if multiple variables are provided. |
+--------+--------------------------------------------------------------------+
| type   | 'map_world', 'map_world_multi', 'map_china', 'map_china_multi'. |
+--------+--------------------------------------------------------------------+
| subtype| - map_world: c("sum", "average", [country names]) | 
|        |     + sum: the map value is calculated by 'sum' (default algorithm). |
|        |     + average: the map value is calculated by 'average'. |
|        |     + [country names]: A set of strings that are valid in Echarts. Refer to 'valid country names' below. |
|        | - map_world_multi: c("sum", "average", [country names]) | 
|        | - map_china: c("sum", "average", [China province names]) | 
|        |     + [China province names]: A set of strings that are valid in Echarts. Refer to 'valid china province names' below. |
|        | - map_china_multi: c("sum", "average", <China province names>) | 
+--------+--------------------------------------------------------------------+

- **Valid country names:**
    - "Afghanistan","Angola","Albania","United Arab Emirates","Argentina","Armenia","French Southern and Antarctic Lands","Australia","Austria","Azerbaijan","Burundi","Belgium","Benin","Burkina Faso","Bangladesh","Bulgaria","The Bahamas","Bosnia and Herzegovina","Belarus","Belize","Bermuda","Bolivia","Brazil","Brunei","Bhutan","Botswana","Central African Republic","Canada","Switzerland","Chile","China","Ivory Coast","Cameroon","Democratic Republic of the Congo","Republic of the Congo","Colombia","Costa Rica","Cuba","Northern Cyprus","Cyprus","Czech Republic","Germany","Djibouti","Denmark","Dominican Republic","Algeria","Ecuador","Egypt","Eritrea","Spain","Estonia","Ethiopia","Finland","Fiji","Falkland Islands","France","Gabon","United Kingdom","Georgia","Ghana","Guinea","Gambia","Guinea Bissau","Equatorial Guinea","Greece","Greenland","Guatemala","French Guiana","Guyana","Honduras","Croatia","Haiti","Hungary","Indonesia","India","Ireland","Iran","Iraq","Iceland","Israel","Italy","Jamaica","Jordan","Japan","Kazakhstan","Kenya","Kyrgyzstan","Cambodia","South Korea","Kosovo","Kuwait","Laos","Lebanon","Liberia","Libya","Sri Lanka","Lesotho","Lithuania","Luxembourg","Latvia","Morocco","Moldova","Madagascar","Mexico","Macedonia","Mali","Myanmar","Montenegro","Mongolia","Mozambique","Mauritania","Malawi","Malaysia","Namibia","New Caledonia","Niger","Nigeria","Nicaragua","Netherlands","Norway","Nepal","New Zealand","Oman","Pakistan","Panama","Peru","Philippines","Papua New Guinea","Poland","Puerto Rico","North Korea","Portugal","Paraguay","Qatar","Romania","Russia","Rwanda","Western Sahara","Saudi Arabia","Sudan","South Sudan","Senegal","Solomon Islands","Sierra Leone","El Salvador","Somaliland","Somalia","Republic of Serbia","Suriname","Slovakia","Slovenia","Sweden","Swaziland","Syria","Chad","Togo","Thailand","Tajikistan","Turkmenistan","East Timor","Trinidad and Tobago","Tunisia","Turkey","United Republic of Tanzania","Uganda","Ukraine","Uruguay","United States of America","Uzbekistan","Venezuela","Vietnam","Vanuatu","West Bank","Yemen","South Africa","Zambia","Zimbabwe"
- **Valid China province names:**
    - "新疆", "西藏", "内蒙古", "青海", "四川", "黑龙江", "甘肃", "云南", "广西", "湖南", "陕西", "广东", "吉林", "河北", "湖北", "贵州", "山东", "江西", "河南", "辽宁", "山西", "安徽", "福建", "浙江", "江苏", "重庆", "宁夏", "海南", "台湾", "北京", "天津", "上海", "香港", "澳门"

# Showcase

## Base Map Mode

If you leave all params NULL except for `type` and/or `subtype`, you will get a base map with no data shown.

### Complete Base Map

Set `type` 'map_world' or 'map_china'. Leave all other params NULL.

```{r}
echartr(NULL, type='map_world') %>% setTitle('World Map')
echartr(NULL, type='map_china') %>% setTitle('China Map')
```

### Partial Base map

You can also display partial maps. Political zones of China can act as the independent mapType, so you can see its subordinate areas.

```{r}
echartr(NULL, type='map_world', subtype='United States of America') %>% 
    setTitle('World Map|USA')
echartr(NULL, type='map_china', subtype='上海') %>% 
    setTitle('China Map|Shanghai')
```

## Extensive Base Map Mode

### Multi-select Base Map

Set `type` 'map_world_multi' or 'map_china_multi', you will get a base map for multiple selection. You can also apply subtypes to it.

```{r}
echartr(NULL, type='map_world_multi') %>% setTitle('World Map')
echartr(NULL, type='map_china_multi', subtype='上海') %>% 
    setTitle('China Map|Shanghai')
```

### Multiple Maps

If you assign `series` and `subtype` with valid geographic names, you will yield separated multiple maps.

```{r}
data <- data.frame(x=c('United States of America', 'China', 'Japan'))
echartr(data, x, series=x, type='map_world', subtype=data$x)
```

## Data Map Mode

You can attach data onto the base map to render it more informative.

### Single Series

If no `x[,2]` is assigned, the map does not differentiate data series.

```{r}
worldgdp <- data.frame(
    country=c('United States of America','China','Japan','Germany',
              'United Kingdom','France','Brazil', 'Italy','India','Russia',
              'Canada','Australia','South Korea','Spain','Mexico','Indonesia',
              'Netherlands','Turkey','Saudi Arabia','Switzerland'),
    GDP=c(17418925,10380380,4616335,3859547,2945146,2846889,2353025,2147952,
          2049501,1857461,1788717,1444189,1416949,1406855,1282725,888648,866354,
          806108,752459,712050))
echartr(worldgdp, country, GDP, type="map_world") %>%
    setTitle("World GDP Top 20, 2014")
```

But point markers are not that informative. Let's color the areas by mapping the data to dataRange.

```{r}
echartr(worldgdp, country, GDP, type="map_world") %>%
    setDataRange(splitNumber=0, 
                 color=getColFromPal('rainbow')) %>%
    setTitle("World GDP Top 20, 2014")
```

### Multiple Series

Let's use `ChinaGDP` dataset with 'Year' as data series variable.

```{r}
str(ChinaGDP)
totGDP <- data.table::dcast(ChinaGDP, Prov~., sum, value.var='GDP')

ChinaGDP <- ChinaGDP[order(ChinaGDP$Year),]
echartr(ChinaGDP, c(Prov, Year), GDP, type="map_china") %>%
    setDataRange(splitNumber=0, valueRange=range(totGDP[, 2]), 
                 color=c('red','orange','yellow','limegreen','green')) %>%
    setTitle("China GDP by Provice, 2012-2014")
```

This applies 'sum' as `mapvalueCalculation` method. Add 'average' to `subtype` to change the method to 'avarge'.

```{r}
echartr(ChinaGDP, c(Prov, Year), GDP, type="map_china", subtype='average') %>%
    setDataRange(splitNumber=0, 
                 color=c('red','orange','yellow','limegreen','green')) %>%
    setTitle("China GDP by Provice, 2012-2014")
```

### Maps with Timeline

Put 'Year' as `z`, we will get a map with timeline.

```{r}
echartr(ChinaGDP, Prov, GDP, z=Year, type="map_china", subtype='average') %>%
    setDataRange(splitNumber=0, 
                 color=c('red','orange','yellow','limegreen','green')) %>%
    setTitle("China GDP by Provice, 2012-2014")
```

## Extensive Data Map Mode

### Multi-select Data Map

Just set `type` 'map_world_multi' or 'map_china_multi'. The rest are similar to above.

### Multiple Maps

Let's tile the countries with top 10 GDP on the chart rather than showing them where they are.

```{r}
worldgdp <- worldgdp[order(worldgdp$GDP, decreasing=TRUE),]
worldgdp10 <- worldgdp[1:10, ]

echartr(worldgdp10, country, GDP, country, type='map_world', 
        subtype=worldgdp10$country) %>% 
    setDataRange(color=c(
        'red', 'orange', 'yellow', 'limegreen', 'green'), pos=4) %>%
    setSymbols('none')
```

# Futher Setup

Then you can configure the widgets, add markLines and/or markPoints, fortify the chart.

## Add/Override nameMap

Maybe you want to show the China province names in English. You can use `addNameMap` or `overrideNameMap` function.

There is a preinstalled dataset **geoNameMap** listing some Chinese and English geographic names. 'LEVEL' is a number ranging from 0 to 3: 0 reprensents country, 1 reprensents province, 2 reprensents city, and, 3 reprensents county. 'FKEY' is foreign key of the parent level. E.g., 'China' is in the record with ID 31, so we can get all the China provinces by `geoNameMap[geoNameMap$FKEY==31,]`. 

```{r}
str(geoNameMap)
```

So we prepare a two-column dictionary of the geographic names: Col 1 is the name in the source language, Col 2 is that in the target language.

```{r}
dict <- geoNameMap[geoNameMap$FKEY==31, c("CN", "EN")]
echartr(NULL, type="map_china_multi") %>% addNameMap(dict, mode='override')
```

## Add/Override markLine

### `addMarkLine`

Based on a base map, we can add markLines using `addMarkLine` (or `addML` for short) or `overrideMarkLine`.

This instance makes use of another preinstalled dataset **flight**.

```{r}
str(flight)
```

```{r}
route <- flight$route
names(route) <- c('name1', 'name2')
coord <- flight$coord
g <- echartr(NULL, type='map_china') %>% 
    addML(series='北京', data=route[route$name1=='北京',]) %>% 
    addML(series='上海', data=route[route$name1=='上海',]) %>% 
    addML(series='广州', data=route[route$name1=='广州',])
g
```

### `addGeoCoord`

But the markLines are not shown yet. You have to append the longitudes and latitudes of the places ever appear in the markLine dataset using `addGeoCoord`.

```{r}
g %>% addGeoCoord(coord)
```

## Add/Override markPoint

### `addMarkPoint`

Based on a base map, we can add markLines using `addMarkPoint` (or `addMP` for short) or `overrideMarkPoint`.

This instance makes use of another preinstalled dataset **chinapm25**.

```{r}
str(chinapm25)
```

```{r}
names(chinapm25) <- c('name', 'value', 'lng', 'lat')

g <- echartr(NULL, type='map_china') %>% 
    addMP(data=chinapm25[,c('name', 'value')], symbolSize=5, itemStyle=list(
        normal=list(borderColor='#87cefa', borderWidth=1,
                    label=list(show=FALSE)), 
        emphasis=list(borderColor='#1e90ff', borderWidth=5, 
                      label=list(show=FALSE))
    )) %>%
    addMP(series='Top 5', 
          data=data.frame(
              name=c('廊坊', '合肥', '菏泽', '武汉', '大庆'),
              value=c(193, 194, 229, 273, 279)), 
          symbol='emptyCircle',
          symbolSize=JS('function (v) {return 10 + v/100;}'), 
          effect=list(show=TRUE)
    ) %>%
    setDataRange(splitNumber=0, valueRange=c(0, 500), color=c(
        'maroon', 'purple', 'red', 'orange', 'yellow', 'lightgreen'))
g
```

### `addGeoCoord`

Although `recharts` can recognize most of the cities, there still might be points missing coordinates. Again, we need to define the geoCoord using `addGeoCoord`.

```{r}
g %>% addGeoCoord(chinapm25[,c('name', 'lng', 'lat')]) 
```

You can refer to related functions to play around on your own.

